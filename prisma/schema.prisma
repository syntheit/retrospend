generator client {
  provider      = "prisma-client"
  output        = "../generated/prisma"
  binaryTargets = ["native", "linux-nixos"]
}

datasource db {
  provider = "postgresql"
}

model User {
  id                    String                        @id @default(cuid())
  name                  String                        @db.VarChar(191)
  username              String                        @unique @db.VarChar(64)
  email                 String                        @unique @db.VarChar(255)
  emailVerified         Boolean                       @default(false)
  image                 String?                       @db.VarChar(2048)
  homeCurrency          String                        @default("USD") @db.VarChar(3)
  categoryClickBehavior CategoryClickBehavior         @default(toggle)
  budgetMode            BudgetMode                    @default(GLOBAL_LIMIT)
  role                  UserRole                      @default(USER)
  isActive              Boolean                       @default(true)
  createdAt             DateTime                      @default(now())
  updatedAt             DateTime                      @default(now()) @updatedAt
  defaultCurrency       String                        @default("USD") @db.VarChar(3)
  fontPreference        FontPreference                @default(sans)
  currencySymbolStyle   CurrencySymbolStyle           @default(standard)
  monthlyIncome         Decimal?                      @db.Decimal(10, 2)
  accounts              Account[]
  assetAccounts         AssetAccount[]
  categories            Category[]
  favoriteExchangeRates ExchangeRateFavorite[]
  expenses              Expense[]
  budgets               Budget[]
  recurringTemplates    RecurringTemplate[]
  createdInviteCodes    InviteCode[]                  @relation("CreatedInviteCodes")
  usedInviteCodes       InviteCode[]                  @relation("UsedInviteCodes")
  sessions              Session[]
  pageSettings          UserPageSetting[]
  analyticsPreferences  AnalyticsCategoryPreference[]

  @@map("user")
}

model Session {
  id        String   @id @default(cuid())
  expiresAt DateTime
  token     String   @unique @db.VarChar(255)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  ipAddress String?  @db.VarChar(255)
  userAgent String?  @db.VarChar(255)
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([expiresAt])
  @@map("session")
}

model Account {
  id                    String    @id @default(cuid())
  accountId             String    @db.VarChar(191)
  providerId            String    @db.VarChar(64)
  userId                String
  accessToken           String?   @db.VarChar(2048)
  refreshToken          String?   @db.VarChar(2048)
  idToken               String?   @db.VarChar(2048)
  accessTokenExpiresAt  DateTime?
  refreshTokenExpiresAt DateTime?
  scope                 String?   @db.VarChar(512)
  password              String?   @db.VarChar(255)
  createdAt             DateTime  @default(now())
  updatedAt             DateTime  @updatedAt
  user                  User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([providerId, accountId])
  @@unique([providerId, userId])
  @@map("account")
}

model Verification {
  id         String   @id @default(cuid())
  identifier String   @db.VarChar(255)
  value      String   @db.VarChar(255)
  expiresAt  DateTime
  createdAt  DateTime @default(now())
  updatedAt  DateTime @default(now()) @updatedAt

  @@map("verification")
}

model Expense {
  id            String        @id @default(cuid())
  userId        String
  title         String
  amount        Decimal       @db.Decimal(19, 8)
  currency      String
  date          DateTime
  categoryId    String?
  amountInUSD   Decimal       @db.Decimal(12, 2)
  exchangeRate  Decimal       @db.Decimal(10, 4)
  pricingSource String
  location      String?       @db.VarChar(191)
  description   String?       @db.VarChar(1000)
  status        ExpenseStatus @default(FINALIZED)
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt

  // Amortization fields
  isAmortizedParent Boolean   @default(false)
  isAmortizedChild  Boolean   @default(false)
  parentId          String?
  parent            Expense?  @relation("AmortizedExpenses", fields: [parentId], references: [id], onDelete: Cascade)
  children          Expense[] @relation("AmortizedExpenses")

  // Recurring subscription reference
  recurringTemplateId String?
  recurringTemplate   RecurringTemplate? @relation(fields: [recurringTemplateId], references: [id], onDelete: SetNull)

  category Category? @relation(fields: [categoryId], references: [id], onDelete: Cascade)
  user     User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, date])
  @@index([parentId])
  @@index([recurringTemplateId])
  @@map("expense")
}

model Category {
  id                   String                        @id @default(cuid())
  name                 String                        @db.VarChar(64)
  color                CategoryColor
  userId               String
  user                 User                          @relation(fields: [userId], references: [id], onDelete: Cascade)
  expenses             Expense[]
  budgets              Budget[]
  recurringTemplates   RecurringTemplate[]
  analyticsPreferences AnalyticsCategoryPreference[]

  @@unique([name, userId])
  @@index([userId])
  @@map("category")
}

model RecurringTemplate {
  id          String             @id @default(cuid())
  userId      String
  name        String             @db.VarChar(191)
  amount      Decimal            @db.Decimal(10, 2)
  currency    String             @default("USD") @db.VarChar(3)
  categoryId  String?
  frequency   RecurringFrequency
  nextDueDate DateTime
  websiteUrl  String?            @db.VarChar(512)
  autoPay     Boolean            @default(true)
  isActive    Boolean            @default(true)
  createdAt   DateTime           @default(now())
  updatedAt   DateTime           @updatedAt

  user     User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  category Category? @relation(fields: [categoryId], references: [id], onDelete: SetNull)
  expenses Expense[]

  @@index([userId, nextDueDate])
  @@index([userId, isActive])
  @@map("recurring_template")
}

model Budget {
  id             String    @id @default(cuid())
  amount         Decimal   @db.Decimal(10, 2)
  currency       String    @default("USD") @db.VarChar(3)
  period         DateTime
  isRollover     Boolean   @default(false)
  rolloverAmount Decimal   @default(0) @db.Decimal(10, 2)
  pegToActual    Boolean   @default(false)
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt
  userId         String
  categoryId     String?
  user           User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  category       Category? @relation(fields: [categoryId], references: [id], onDelete: Cascade)

  @@unique([userId, categoryId, period])
  @@index([userId, period])
  @@map("budget")
}

model ExchangeRate {
  id        String                 @id @default(cuid())
  date      DateTime
  currency  String                 @db.VarChar(3)
  type      String                 @default("official") @db.VarChar(32)
  rate      Decimal                @db.Decimal(18, 6)
  createdAt DateTime               @default(now())
  updatedAt DateTime               @updatedAt
  favorites ExchangeRateFavorite[]

  @@unique([date, currency, type])
  @@index([currency, type, date])
  @@map("exchange_rate")
}

model ExchangeRateFavorite {
  id             String       @id @default(cuid())
  userId         String
  exchangeRateId String
  order          Int          @default(0)
  createdAt      DateTime     @default(now())
  exchangeRate   ExchangeRate @relation(fields: [exchangeRateId], references: [id], onDelete: Cascade)
  user           User         @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, exchangeRateId])
  @@unique([userId, order])
  @@map("exchange_rate_favorite")
}

model AssetAccount {
  id               String          @id @default(cuid())
  userId           String
  name             String
  type             AssetType
  currency         String
  balance          Decimal         @db.Decimal(19, 8)
  exchangeRate     Decimal?        @db.Decimal(18, 6)
  exchangeRateType String?         @db.VarChar(32)
  isLiquid         Boolean         @default(false)
  interestRate     Float?
  minimumPayment   Decimal?        @db.Decimal(10, 2)
  dueDate          Int?
  createdAt        DateTime        @default(now())
  updatedAt        DateTime        @updatedAt
  user             User            @relation(fields: [userId], references: [id], onDelete: Cascade)
  snapshots        AssetSnapshot[]
  history          AssetHistory[]

  @@index([userId])
  @@map("asset_account")
}

model AssetSnapshot {
  id           String       @id @default(cuid())
  accountId    String
  date         DateTime
  balance      Decimal      @db.Decimal(19, 8)
  balanceInUSD Decimal      @db.Decimal(12, 2)
  account      AssetAccount @relation(fields: [accountId], references: [id], onDelete: Cascade)

  @@unique([accountId, date])
  @@map("asset_snapshot")
}

model AssetHistory {
  id         String       @id @default(cuid())
  assetId    String
  balance    Decimal      @db.Decimal(19, 8)
  recordedAt DateTime     @default(now())
  asset      AssetAccount @relation(fields: [assetId], references: [id], onDelete: Cascade)

  @@index([assetId, recordedAt])
  @@map("asset_history")
}

model InviteCode {
  id          String    @id @default(cuid())
  code        String    @unique
  isActive    Boolean   @default(true)
  usedAt      DateTime?
  expiresAt   DateTime?
  createdById String
  usedById    String?
  createdAt   DateTime  @default(now())
  createdBy   User      @relation("CreatedInviteCodes", fields: [createdById], references: [id], onDelete: Cascade)
  usedBy      User?     @relation("UsedInviteCodes", fields: [usedById], references: [id])

  @@map("invite_code")
}

model AppSettings {
  id                             String   @id @default("app_settings_singleton")
  inviteOnlyEnabled              Boolean  @default(false)
  createdAt                      DateTime @default(now())
  updatedAt                      DateTime @updatedAt
  allowAllUsersToGenerateInvites Boolean  @default(false)

  @@map("app_settings")
}

enum CategoryColor {
  emerald
  blue
  sky
  cyan
  teal
  orange
  amber
  violet
  pink
  fuchsia
  indigo
  slate
  zinc
  lime
  neutral
  gray
  purple
  yellow
  stone
  rose
  red
}

enum CategoryClickBehavior {
  navigate
  toggle
}

enum FontPreference {
  sans
  mono
}

enum CurrencySymbolStyle {
  native
  standard
}

enum UserRole {
  USER
  ADMIN
}

enum ExpenseStatus {
  DRAFT
  FINALIZED
}

enum RecurringFrequency {
  WEEKLY
  MONTHLY
  YEARLY
}

enum AssetType {
  CASH
  INVESTMENT
  CRYPTO
  REAL_ESTATE
  VEHICLE
  LIABILITY_LOAN
  LIABILITY_CREDIT_CARD
  LIABILITY_MORTGAGE
}

enum BudgetMode {
  GLOBAL_LIMIT
  SUM_OF_CATEGORIES
}

enum Page {
  DASHBOARD
  BUDGET
  ANALYTICS
  WEALTH
  EXCHANGE_RATES
  SETTINGS
  TABLE
  ACCOUNT
  INVITE_CODES
  ADMIN
  EXPENSE
}

model UserPageSetting {
  id       String @id @default(cuid())
  userId   String
  page     Page
  settings Json
  user     User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, page])
  @@map("user_page_setting")
}

model AnalyticsCategoryPreference {
  id         String   @id @default(cuid())
  userId     String
  categoryId String
  isFlexible Boolean  @default(false)
  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  category   Category @relation(fields: [categoryId], references: [id], onDelete: Cascade)

  @@unique([userId, categoryId])
  @@map("analytics_category_preference")
}

model SystemStatus {
  key       String   @id
  value     Json
  updatedAt DateTime @updatedAt

  @@map("system_status")
}
